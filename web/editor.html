<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Editor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
  <style type="text/css" media="screen">
    body {
        /* overflow: hidden; */
        padding-top: 20px;
    }

    #editor {
        /*
        margin: 0;
        position: absolute;
        */
        width: 100%;
        height: 200px;
    }
    #cpp {
        /*
        left: 0px; 
        top: 300px;
        position: absolute;
        */
        width: 100%;
        height: 500px;
    }
    #python {
        /*
        left: 550px; 
        top: 300px;
        position: absolute;
        */
        width: 100%;
        height: 500px;
    }
    #latex {
        /*
        left: 1100px; 
        top: 300px;
        position: absolute;
        */
        width: 100%;
        height: 500px;
    }
    #compile {
        /*
        left: 520px; 
        position: absolute;
        */
        background-color: #4CAF50; /* Green background */
        border: none; /* Remove borders */
        color: white; /* White text */
        padding: 12px 16px; /* Some padding */
        font-size: 16px /* Set a font size */
    }
    #msg {
        /*
        left: 520px;
        top: 40px;
        position: absolute;
        */
        font-size: 16px /* Set a font size */
    }
    #output {
      border: 0px solid grey;
      /*
      position: absolute;
      left: 650px;
      */
      width: 100%;
      height: 200px;
      font-size: 120%;
      box-sizing: border-box;
    }
  </style>
  <script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.4.12/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

  <script>
    function convert(input) {
      output = document.getElementById('output');
      output.innerHTML = '';
      MathJax.texReset();
      var options = MathJax.getMetricsFor(output);
      options.display = 1;
      MathJax.tex2chtmlPromise(input, options).then(function (node) {
        output.appendChild(node);
        MathJax.startup.document.clear();
        MathJax.startup.document.updateDocument();
      }).catch(function (err) {
        output.appendChild(document.createElement('pre')).appendChild(document.createTextNode(err.message));
      }).then(function () { 
      });
    }

    function checkBrowserVer(){
      var nVer = navigator.appVersion;
      var nAgt = navigator.userAgent;
      var browserName  = navigator.appName;
      var fullVersion  = ''+parseFloat(navigator.appVersion);
      var majorVersion = parseInt(navigator.appVersion,10);
      var nameOffset,verOffset,ix;
      var validBrowser = false;
      // In Opera, the true version is after "Opera" or after "Version"
      if ((verOffset=nAgt.indexOf("Opera"))!=-1) {
       browserName = "Opera";
       fullVersion = nAgt.substring(verOffset+6);
       if ((verOffset=nAgt.indexOf("Version"))!=-1)
         fullVersion = nAgt.substring(verOffset+8);
      }
      // In MSIE, the true version is after "MSIE" in userAgent
      else if ((verOffset=nAgt.indexOf("MSIE"))!=-1) {
       browserName = "Microsoft Internet Explorer";
       fullVersion = nAgt.substring(verOffset+5);
      }
      // In Chrome, the true version is after "Chrome"
      else if ((verOffset=nAgt.indexOf("Chrome"))!=-1) {
       browserName = "Chrome";
       fullVersion = nAgt.substring(verOffset+7);
       validBrowser = true;
      }
      // In Safari, the true version is after "Safari" or after "Version"
      else if ((verOffset=nAgt.indexOf("Safari"))!=-1) {
       browserName = "Safari";
       fullVersion = nAgt.substring(verOffset+7);
       if ((verOffset=nAgt.indexOf("Version"))!=-1)
         fullVersion = nAgt.substring(verOffset+8);
      }
      // In Firefox, the true version is after "Firefox"
      else if ((verOffset=nAgt.indexOf("Firefox"))!=-1) {
       browserName = "Firefox";
       fullVersion = nAgt.substring(verOffset+8);
       validBrowser = true;
      }
      // In most other browsers, "name/version" is at the end of userAgent
      else if ( (nameOffset=nAgt.lastIndexOf(' ')+1) <
                (verOffset=nAgt.lastIndexOf('/')) )
      {
       browserName = nAgt.substring(nameOffset,verOffset);
       fullVersion = nAgt.substring(verOffset+1);
       if (browserName.toLowerCase()==browserName.toUpperCase()) {
        browserName = navigator.appName;
       }
      }
      // trim the fullVersion string at semicolon/space if present
      if ((ix=fullVersion.indexOf(";"))!=-1)
         fullVersion=fullVersion.substring(0,ix);
      if ((ix=fullVersion.indexOf(" "))!=-1)
         fullVersion=fullVersion.substring(0,ix);

      majorVersion = parseInt(''+fullVersion,10);
      if (isNaN(majorVersion)) {
       fullVersion  = ''+parseFloat(navigator.appVersion);
       majorVersion = parseInt(navigator.appVersion,10);
      }
      if (validBrowser){
        msg = "Valid browser!";
      }
      else{
        msg = "You are using " + browserName + ", please use Chrome or Firefox!";
      }
      console.log(msg);
      return msg;
    }

    function updateEditor(code) {
      var cpp = ace.edit("cpp");
      cpp.session.setValue(code[1]);
      var python = ace.edit("python");
      python.session.setValue(code[0]);
      var latex = ace.edit("latex");
      latex.session.setValue(code[2]);
      convert(code[3]);
      // reset UI
      document.getElementById("submit_icon").className = "fa fa-refresh";
      document.getElementById("compile").disabled = false;
    }

    function updateError(err) {
      console.log(err);
    }


    function compileFunction(){
        var iheartla = ace.edit("editor");
        var source = iheartla.getValue();
        console.log(source)
      // source = 'a=2'
        pythonCode = `
import iheartla.la_parser.parser
iheartla.la_parser.parser.compile_la_content(r"""` + source + `""")`
      context = 'ddd'

        console.log(pythonCode)
      console.log(Base64.encode(pythonCode))
        // var code = pyodide.runPython(pythonCode);
        // pyodide.runPythonAsync(pythonCode)
        // .then(output => updateEditor(output))
        // .catch((err) => { updateError(err) });
        background(pythonCode);
        console.log("code")
    }

    function resultReceiver(event) {
      var n = parseInt(event.data);
      console.log(event.data);
    }

    function clickCompile(){
      try {
        document.getElementById("submit_icon").className = "fa fa-refresh fa-spin";
        document.getElementById("compile").disabled = true;
        console.log('start');
        compileFunction();
        // var blob = new Blob([
        //   "onmessage = function(e) { pyodide.runPython('print(2)');; postMessage('msg from worker'); }"
        // ], { type: "text/javascript" })
        // var worker = new Worker(window.URL.createObjectURL(blob));
        // worker.onmessage = function(e) {
        //   console.log("Received: " + e.data);
        // }
        // worker.postMessage("hello"); // Start the worker.
        console.log('end');
      } catch (error) {
        console.error(error);
        document.getElementById("submit_icon").className = "fa fa-refresh";
        document.getElementById("compile").disabled = false;
      }
      finally {
      }
    }

    function showMsg(msg){
      document.getElementById("msg").innerHTML = msg;
      setTimeout(function(){ document.getElementById("msg").innerHTML = ''; }, 2000);
    }
 
  </script>

<body>

<div class="container">
<div class="row">
<div class="col-sm">

<pre id="editor">[ t^3 t^2 t 1 ] [ -1  3 -3  1
                   3 -6  3  0
                  -3  3  0  0
                   1  0  0  0 ] P
where
t ∈ ℝ
P ∈ ℝ^(4 × d)</pre>

</div>
<div class="col-sm">

<button id="compile" class="btn btn-success" onclick="clickCompile()">
  <i id="submit_icon" class="fa fa-refresh"></i> Compile
<!--  <i id="submit_icon" class="fa fa-refresh fa-spin"></i> Compile-->
</button>
<div id="msg" class="alert alert-primary" role="alert"></div>

</div>
<div class="col-sm">
<div id="output"></div>
</div>
</div>

<div class="row">
<div class="col-lg">
    <pre id="cpp">cpp</pre>
</div>
<div class="col-lg">
    <pre id="python">python</pre>
</div>
<div class="col-lg">
    <pre id="latex">latex</pre>
</div>
</div>

</div>

</body>

<script>
msg = checkBrowserVer();
showMsg(msg);
</script>

<script>
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/twilight");
    editor.session.setMode("ace/mode/text");

    var cpp = ace.edit("cpp");
    cpp.setTheme("ace/theme/twilight");
    cpp.session.setMode("ace/mode/c_cpp");
    cpp.setOptions({
      readOnly: true,
    });

    var python = ace.edit("python");
    python.setTheme("ace/theme/twilight");
    python.session.setMode("ace/mode/python");
    cpp.setOptions({
      readOnly: true, 
    });

    var latex = ace.edit("latex");
    latex.setTheme("ace/theme/twilight");
    latex.session.setMode("ace/mode/latex");
    cpp.setOptions({
      readOnly: true, 
    });
</script>

<script type="text/javascript">
  // set the pyodide files URL (packages.json, pyodide.asm.data etc)
   window.languagePluginUrl = 'https://cdn.jsdelivr.net/pyodide/v0.16.1/full/';
</script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/pyodide/v0.16.1/full/pyodide.js"></script>
<script type="text/javascript" src='./py-worker.js'></script>
<script src="https://cdn.jsdelivr.net/npm/js-base64@3.6.0/base64.min.js"></script>
<script>
let iheartla = new URL("./iheartla-0.0.1-py3-none-any.whl", document.baseURI).href;
let pythonCode = `
import micropip
micropip.install('appdirs')
micropip.install('tatsu')
micropip.install('${iheartla}')
`
// pythonCode = `print("aaaaaa")`
// languagePluginLoader.then(() => {
//   return pyodide.loadPackage(['micropip'])
// }).then(() => {
//   pyodide.version();
//   pyodide.runPython(pythonCode);
// })

async function background(source, context){
    try {
        const {results, error} = await asyncRun(Base64.encode(source), context);
        if (results) {
            console.log('pyodideWorker return results: ', results);
            if (Array.isArray(results)){
              updateEditor(results);
            }
        } else if (error) {
            console.log('pyodideWorker error: ', error);
        }
    }
    catch (e){
        console.log(`Error in pyodideWorker at ${e.filename}, Line: ${e.lineno}, ${e.message}`)
    }
}

background(pythonCode);
</script>

</html>
